var fledgeframe=function(){"use strict";let e=[];const o={},n="%c ";function t(t){return function(...r){const s=[],a=[];r.forEach((t=>{if(t===o){const o=e.shift();s.push(`%c${o.value}`,n),a.push(o.css,"")}else"object"==typeof t||"function"==typeof t?(s.push("%o",n),a.push(t,"")):(s.push(`%c${t}`,n),a.push("",""))})),t(s.join(""),...a),e=[]}}const r={assert:t(console.assert),clear:t(console.clear),count:t(console.count),countReset:t(console.countReset),debug:t(console.debug),dir:t(console.dir),error:t(console.error),group:t(console.group),groupCollapsed:t(console.groupCollapsed),groupEnd:t(console.groupEnd),info:t(console.info),log:t(console.log),table:t(console.table),time:t(console.time),timeEnd:t(console.timeEnd),timeLog:t(console.timeLog),trace:t(console.trace),warn:t(console.warn),asAlert:function(n){return e.push({value:n,css:"display: inline-block; background-color: #dc3545; color: #ffffff; font-weight: bold; padding: 3px 7px 3px 7px; border-radius: 3px 3px 3px 3px;"}),o},asInfo:function(n){return e.push({value:n,css:"color: #0366d6; font-weight: bold;"}),o},asProcess:function(n){return e.push({value:`${n}â€¦`,css:"color: #8c8c8c; font-style: italic;"}),o},asSuccess:function(n){return e.push({value:n,css:"color: #289d45; font-weight: bold;"}),o},asWarning:function(n){return e.push({value:n,css:"display: inline-block; background-color: #ffc107; color: black; font-weight: bold; padding: 3px 7px 3px 7px; border-radius: 3px 3px 3px 3px;"}),o}};function s(e){return new Promise(((o,n)=>{e.oncomplete=e.onsuccess=()=>o(e.result),e.onabort=e.onerror=()=>n(e.error)}))}function a(e,o){const n=indexedDB.open(e);n.onupgradeneeded=()=>n.result.createObjectStore(o);const t=s(n);return(e,n)=>t.then((t=>n(t.transaction(o,e).objectStore(o))))}let i;function c(){return i||(i=a("keyval-store","keyval")),i}function l(e=c()){const o=[];return function(e,o){return e("readonly",(e=>(e.openCursor().onsuccess=function(){this.result&&(o(this.result),this.result.continue())},s(e.transaction))))}(e,(e=>o.push([e.key,e.value]))).then((()=>o))}const u=a("fledge.v1","interest-groups"),g=(e,o)=>`${e}-${o}`;async function d(e,o,n){n&&r.groupCollapsed("Fledge API: joinAdInterest");const t=g(e.owner,e.name),a=await function(e,o=c()){return o("readonly",(o=>s(o.get(e))))}(t,u);return n&&r.log(r.asInfo("checking for an existing interest group:"),a),a?(n&&r.log(r.asProcess("updating an interest group")),await function(e,o,n=c()){return n("readwrite",(n=>new Promise(((t,r)=>{n.get(e).onsuccess=function(){try{n.put(o(this.result),e),t(s(n.transaction))}catch(e){r(e)}}}))))}(t,{_expired:Date.now()+o,...e},u)):(n&&r.log(r.asProcess("creating a new interest group")),await function(e,o,n=c()){return n("readwrite",(n=>(n.put(o,e),s(n.transaction))))}(t,{_created:Date.now(),_expired:Date.now()+o,_updated:Date.now(),...e},u)),n&&r.log(r.asSuccess("interest group id:"),t),n&&r.groupEnd(),!0}async function p(e,o){return o&&r.groupCollapsed("Fledge API: leaveAdInterest"),o&&r.log(r.asProcess("deleting an existing interest group")),await function(e,o=c()){return o("readwrite",(o=>(o.delete(e),s(o.transaction))))}(g(e.owner,e.name),u),o&&r.log(r.asSuccess("interest group deleted")),o&&r.groupEnd(),!0}const f=async(e,o,n)=>{n&&r.groupCollapsed("auction utils: getTrustedSignals");const t=`hostname=${window.top.location.hostname}`;if(!e||!o)return n&&r.log(r.asWarning("No 'url' or 'keys' found!")),void(n&&r.groupEnd());const s=await fetch(`${e}?${t}&keys=${o.join(",")}`).then((e=>{if(!e.ok)throw new Error("Something went wrong! The response returned was not ok.");if(!(e=>/\bapplication\/json\b/.test(e?.headers?.get("content-type")))(e))throw new Error("Response was not in the format of JSON.");return e.json()})).catch((e=>(n&&r.log(r.asAlert("There was a problem with your fetch operation:")),n&&r.log(e),null))),a={};for(const[e,n]of s)o.includes(e)&&(a[e]=n);return a&&0===Object.keys(a).length&&a.constructor===Object?(n&&r.groupEnd(),a):(n&&r.log(r.asWarning("No signals found!")),n&&r.groupEnd(),null)};async function w(e,o){o&&r.groupCollapsed("Fledge API: runAdAuction");const n=await l(u);o&&r.log(r.asInfo("all interest groups:"),n);const t=((e,o,n)=>{if(n&&r.groupCollapsed("auction utils: getEligible"),"*"===o)return n&&r.info("using the wildcard yields all groups"),n&&r.groupEnd(),e;const t=e.filter((([e,n])=>o.includes(n.owner)));return t.length?(n&&r.info("found some eligible buyers"),n&&r.groupEnd(),t):(n&&r.log(r.asWarning("No groups were eligible!")),n&&r.groupEnd(),null)})(n,e.interest_group_buyers,o);if(o&&r.log(r.asInfo('eligible buyers based on "interest_group_buyers":'),t),!t)return o&&r.log(r.asAlert("No eligible interest group buyers found!")),null;const s=await(async(e,o,n)=>Promise.all(e.map((async([e,t])=>{n&&r.groupCollapsed(`auction utils: getBids => ${e}`);const s=performance.now(),{generateBid:a,generate_bid:i}=await import(t.bidding_logic_url);let c=a;if(i&&!a&&(c=i),!c&&"function"!=typeof c)return n&&r.log(r.asWarning("No 'generateBid' function found!")),n&&r.groupEnd(),null;const l=await f(t?.trusted_bidding_signals_url,t?.trusted_bidding_signals_keys,n);let u;try{u=c(t,o?.auction_signals,o?.per_buyer_signals?.[t.owner],l,{top_window_hostname:window.top.location.hostname,seller:o.seller}),n&&r.log(r.asInfo("bid:"),u)}catch(e){return n&&r.log(r.asAlert("There was an error in the 'generateBid' function:")),n&&r.log(e),null}if(!(u.ad&&"object"==typeof u.ad&&u.bid&&"number"==typeof u.bid&&u.render)||"string"!=typeof u.render&&!Array.isArray(u.render))return n&&r.log(r.asWarning("No bid found!")),n&&r.groupEnd(),null;const g=performance.now();return n&&r.groupEnd(),{...t,...u,duration:g-s}}))))(t,e,o);o&&r.log(r.asInfo("all bids from each buyer:"),s);const a=s.filter((e=>e));if(o&&r.log(r.asInfo("filtered bids:"),a),!a.length)return o&&r.log(r.asAlert("No bids found!")),o&&r.groupEnd(),null;o&&r.log(r.asProcess("getting all scores, filtering and sorting"));const[i]=await(async(e,o,n)=>{n&&r.groupCollapsed("auction utils: getScores");const{scoreAd:t,score_ad:s}=await import(o.decision_logic_url);let a=t;return s&&!t&&(a=s),a||"function"==typeof a?e.map((e=>{let t;try{t=a(e?.ad,e?.bid,o,o?.trusted_scoring_signals,{top_window_hostname:window.top.location.hostname,interest_group_owner:e.owner,interest_group_name:e.name,bidding_duration_msec:e.duration}),n&&r.log(r.asInfo("score:"),t)}catch(e){n&&r.log(r.asAlert("There was an error in the 'scoreAd' function:")),n&&r.log(e),t=-1}return n&&r.groupEnd(),{bid:e,score:t}})).filter((({score:e})=>e>0)).sort(((e,o)=>e.score>o.score?1:-1)):(n&&r.log(r.asWarning("No 'scoreAd' function was found!")),null)})(a,e,o);if(o&&r.log(r.asInfo("winner:"),i),!i)return o&&r.log(r.asAlert("No winner found!")),o&&r.groupEnd(),null;o&&r.log(r.asProcess("creating an entry in the auction store"));const c=([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,(e=>(e^crypto.getRandomValues(new Uint8Array(1))[0]&15>>e/4).toString(16)));return sessionStorage.setItem(c,JSON.stringify({origin:`${window.top.location.origin}${window.top.location.pathname}`,timestamp:Date.now(),conf:e,...i})),o&&r.log(r.asSuccess("auction token:"),c),o&&r.groupEnd(),c}async function h({data:e,ports:o}){try{if(!Array.isArray(e))throw new Error(`The API expects the data to be in the form of an array, with index 0 set to the action, and index 1 set to the data.  A ${typeof e} was passed instead.`);switch(e[0]){case"joinAdInterestGroup":{const[,o]=e,[n,t,r]=o;return await d(n,t,r),!0}case"leaveAdInterestGroup":{const[,o]=e,[n,t]=o;return await p(n,t),!0}case"runAdAuction":{const[,n]=e,[t,r]=n;if(1!==o.length)throw new Error(`Port transfer mismatch during request: expected 1 port, but received ${o.length}`);const[s]=o,a=[!0,await w(t,r)];return s.postMessage(a),s.close(),!0}default:return!1}}catch(e){const n=[!1];for(const e of o)e.postMessage(n);throw e}}return async function(){const{searchParams:e}=new URL(window.location),o=e.get("debug")||!1;if(o&&r.group("Fledge: Storage Frame"),!(e.get("admin")||!1)){const[e]=window.location.ancestorOrigins;if(void 0===e)throw o&&r.log(r.asWarning("It appears your attempting to access this from the top-level document")),o&&r.log({origin:e,location:window.location}),new Error("Can't call 'postMessage' on the Frame window when run as a top-level document");const{port1:n,port2:t}=new MessageChannel;o&&r.log("message channel receiver:",n),o&&r.log("message channel sender:",t),n.onmessage=h,window.parent.postMessage({"fledge.polyfill":1},e,[t])}o&&r.groupEnd()}}();

var fledgeframe=function(){"use strict";function t(t){return new Promise(((e,n)=>{t.oncomplete=t.onsuccess=()=>e(t.result),t.onabort=t.onerror=()=>n(t.error)}))}function e(e,n){const r=indexedDB.open(e);r.onupgradeneeded=()=>r.result.createObjectStore(n);const o=t(r);return(t,e)=>o.then((r=>e(r.transaction(n,t).objectStore(n))))}let n;function r(){return n||(n=e("keyval-store","keyval")),n}function o(e=r()){const n=[];return function(e,n){return e("readonly",(e=>(e.openCursor().onsuccess=function(){this.result&&(n(this.result),this.result.continue())},t(e.transaction))))}(e,(t=>n.push([t.key,t.value]))).then((()=>n))}const a=e("fledge.v1","interest-groups"),s=(t,e)=>`${t}-${e}`;async function i(e,n){const o=s(e.owner,e.name);await function(e,n=r()){return n("readonly",(n=>t(n.get(e))))}(o,a)?await function(e,n,o=r()){return o("readwrite",(r=>new Promise(((o,a)=>{r.get(e).onsuccess=function(){try{r.put(n(this.result),e),o(t(r.transaction))}catch(t){a(t)}}}))))}(o,(t=>({...t,...e,_expired:Date.now()+n})),a):await function(e,n,o=r()){return o("readwrite",(r=>(r.put(n,e),t(r.transaction))))}(o,{_created:Date.now(),_expired:Date.now()+n,_updated:Date.now(),...e},a)}async function c(e){await function(e,n=r()){return n("readwrite",(n=>(n.delete(e),t(n.transaction))))}(s(e.owner,e.name),a)}const u=async(t,e)=>{const n=`hostname=${window.top.location.hostname}`;if(!t||!e)return;let r;try{const o=await fetch(`${t}?${n}&keys=${e.join(",")}`);if(!o.ok)return null;if(!(t=>/\bapplication\/json\b/.test(t?.headers?.get("content-type")))(o))return null;r=await o.json()}catch(t){return null}const o={};for(const t in r)e.includes(t)&&(o[t]=r[t]);return o&&0!==Object.keys(o).length&&o.constructor===Object?o:null};async function l(t){const e=((t,e)=>{if("*"===e)return t;const n=t.filter((([t,n])=>e.includes(n.owner)));return n.length?n:null})(await o(a),t.interestGroupBuyers);if(!e)return null;const n=(await(async(t,e)=>Promise.all(t.map((async([t,n])=>{const r=performance.now(),{generateBid:o}=await import(n.biddingLogicUrl);if(!o&&"function"!=typeof o)return null;const a=await u(n?.trustedBiddingSignalsUrl,n?.trustedBiddingSignalsKeys);let s;try{s=o(n,e?.auctionSignals,e?.perBuyerSignals?.[n.owner],a,{topWindowHostname:window.top.location.hostname,seller:e.seller})}catch(t){return null}if(!(s.ad&&"object"==typeof s.ad&&s.bid&&"number"==typeof s.bid&&s.render)||"string"!=typeof s.render&&!Array.isArray(s.render))return null;const i=performance.now();return{...n,...s,duration:i-r}}))))(e,t)).filter((t=>t));if(!n.length)return null;const r=await(async(t,e)=>{const{scoreAd:n}=await import(e.decisionLogicUrl);return n||"function"==typeof n?Promise.all(t.map((async t=>{let r;t.ad&&t.ad.length>0&&(r=t?.ad?.map((({renderUrl:t})=>t)));const o=await u(e?.trustedScoringSignalsUrl,r);let a;try{a=n(t?.ad,t?.bid,e,o,{topWindowHostname:window.top.location.hostname,interestGroupOwner:t.owner,interestGroupName:t.name,biddingDurationMsec:t.duration})}catch(t){a=-1}return{bid:t,score:a}}))):null})(n,t),[s]=r.filter((({score:t})=>t>0)).sort(((t,e)=>t.score>e.score?1:-1));if(!s)return null;const i=([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,(t=>(t^crypto.getRandomValues(new Uint8Array(1))[0]&15>>t/4).toString(16)));return sessionStorage.setItem(i,JSON.stringify({origin:`${window.top.location.origin}${window.top.location.pathname}`,timestamp:Date.now(),conf:t,...s})),i}async function d({data:t,ports:e}){try{if(!Array.isArray(t))throw new Error(`The API expects the data to be in the form of an array, with index 0 set to the action, and index 1 set to the data.  A ${typeof t} was passed instead.`);switch(t[0]){case"joinAdInterestGroup":{const[,e]=t,[n,r]=e;return await i(n,r),!0}case"leaveAdInterestGroup":{const[,e]=t,[n]=e;return await c(n),!0}case"runAdAuction":{const[,n]=t,[r]=n;if(1!==e.length)throw new Error(`Port transfer mismatch during request: expected 1 port, but received ${e.length}`);const[o]=e,a=[!0,await l(r)];return o.postMessage(a),o.close(),!0}default:return!1}}catch(t){const n=[!1];for(const t of e)t.postMessage(n);throw t}}return async function(){const[t]=window.location.ancestorOrigins;if(void 0===t)throw new Error("Can't call 'postMessage' on the Frame window when run as a top-level document");const{port1:e,port2:n}=new MessageChannel;e.onmessage=d,window.parent.postMessage({"fledge.polyfill":1},t,[n])}}();

var fledgeframe=function(){"use strict";let e=[];const t={},n="%c ";function r(r){return function(...o){const a=[],s=[];o.forEach((r=>{if(r===t){const t=e.shift();a.push(`%c${t.value}`,n),s.push(t.css,"")}else"object"==typeof r||"function"==typeof r?(a.push("%o",n),s.push(r,"")):(a.push(`%c${r}`,n),s.push("",""))})),r(a.join(""),...s),e=[]}}var o={error:r(console.error),info:r(console.info),log:r(console.log),group:r(console.group),groupEnd:r(console.groupEnd),table:r(console.table),trace:r(console.trace),warn:r(console.warn),asAlert:function(n){return e.push({value:n,css:"display: inline-block ; background-color: #e0005a ; color: #ffffff ; font-weight: bold ; padding: 3px 7px 3px 7px ; border-radius: 3px 3px 3px 3px ;"}),t},asWarning:function(n){return e.push({value:n,css:"display: inline-block ; background-color: gold ; color: black ; font-weight: bold ; padding: 3px 7px 3px 7px ; border-radius: 3px 3px 3px 3px ;"}),t}};let a,s;const i=new WeakMap,c=new WeakMap,u=new WeakMap,l=new WeakMap,d=new WeakMap;let p={get(e,t,n){if(e instanceof IDBTransaction){if("done"===t)return c.get(e);if("objectStoreNames"===t)return e.objectStoreNames||u.get(e);if("store"===t)return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return w(e[t])},set:(e,t,n)=>(e[t]=n,!0),has:(e,t)=>e instanceof IDBTransaction&&("done"===t||"store"===t)||t in e};function g(e){return e!==IDBDatabase.prototype.transaction||"objectStoreNames"in IDBTransaction.prototype?(s||(s=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])).includes(e)?function(...t){return e.apply(h(this),t),w(i.get(this))}:function(...t){return w(e.apply(h(this),t))}:function(t,...n){const r=e.call(h(this),t,...n);return u.set(r,t.sort?t.sort():[t]),w(r)}}function f(e){return"function"==typeof e?g(e):(e instanceof IDBTransaction&&function(e){if(c.has(e))return;const t=new Promise(((t,n)=>{const r=()=>{e.removeEventListener("complete",o),e.removeEventListener("error",a),e.removeEventListener("abort",a)},o=()=>{t(),r()},a=()=>{n(e.error||new DOMException("AbortError","AbortError")),r()};e.addEventListener("complete",o),e.addEventListener("error",a),e.addEventListener("abort",a)}));c.set(e,t)}(e),t=e,(a||(a=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])).some((e=>t instanceof e))?new Proxy(e,p):e);var t}function w(e){if(e instanceof IDBRequest)return function(e){const t=new Promise(((t,n)=>{const r=()=>{e.removeEventListener("success",o),e.removeEventListener("error",a)},o=()=>{t(w(e.result)),r()},a=()=>{n(e.error),r()};e.addEventListener("success",o),e.addEventListener("error",a)}));return t.then((t=>{t instanceof IDBCursor&&i.set(t,e)})).catch((()=>{})),d.set(t,e),t}(e);if(l.has(e))return l.get(e);const t=f(e);return t!==e&&(l.set(e,t),d.set(t,e)),t}const h=e=>d.get(e);const b=["get","getKey","getAll","getAllKeys","count"],y=["put","add","delete","clear"],m=new Map;function _(e,t){if(!(e instanceof IDBDatabase)||t in e||"string"!=typeof t)return;if(m.get(t))return m.get(t);const n=t.replace(/FromIndex$/,""),r=t!==n,o=y.includes(n);if(!(n in(r?IDBIndex:IDBObjectStore).prototype)||!o&&!b.includes(n))return;const a=async function(e,...t){const a=this.transaction(e,o?"readwrite":"readonly");let s=a.store;return r&&(s=s.index(t.shift())),(await Promise.all([s[n](...t),o&&a.done]))[0]};return m.set(t,a),a}p=(e=>({...e,get:(t,n,r)=>_(t,n)||e.get(t,n,r),has:(t,n)=>!!_(t,n)||e.has(t,n)}))(p);const v="auction",x="interest-groups",D=function(e,t,{blocked:n,upgrade:r,blocking:o,terminated:a}={}){const s=indexedDB.open(e,t),i=w(s);return r&&s.addEventListener("upgradeneeded",(e=>{r(w(s.result),e.oldVersion,e.newVersion,w(s.transaction))})),n&&s.addEventListener("blocked",(()=>n())),i.then((e=>{a&&e.addEventListener("close",(()=>a())),o&&e.addEventListener("versionchange",(()=>o()))})).catch((()=>{})),i}("Fledge",1,{upgrade(e){const t=e.createObjectStore(x,{keyPath:"_key"});["owner","name","_expired"].forEach((e=>{t.createIndex(e,e,{unique:!1})})),e.createObjectStore(v,{keyPath:"id"})}});var E={db:D,store:{add:async function(e,t){return(await D).add(e,{...t,_created:Date.now(),_updated:Date.now()})},get:async function(e,t){const n=(await D).get(e,t);return n||null},getAll:async function(e){const t=(await D).getAll(e);return t||null},put:async function(e,t,n){const r={...t,...n,_updated:Date.now()};return(await D).put(e,r)},delete:async function(e,t){return(await D).delete(e,t)}}};const k=async(e,t,n)=>{const r=`hostname=${window.top.location.hostname}`;if(!e||!t)return;const a=await fetch(`${e}?${r}&keys=${t.join(",")}`).then((e=>{if(!e.ok)throw new Error("Something went wrong! The response returned was not ok.");if(!(e=>/\bapplication\/json\b/.test(e?.headers?.get("content-type")))(e))throw new Error("Response was not in the format of JSON.");return e.json()})).catch((e=>(n&&o.error("There was a problem with your fetch operation:",e),null))),s={};for(const[e,n]of a)t.includes(e)&&(s[e]=n);return s&&0===Object.keys(s).length&&s.constructor===Object?s:null};async function I(e,t){t&&o.info("getting all interest groups");const n=await E.store.getAll(x);t&&o.table(n),t&&o.info('checking eligibility of buyers based on "interest_group_buyers"');const r=((e,t)=>{if("*"===t)return e;const n=e.filter((({owner:e})=>t.includes(e)));return n.length?n:null})(n,e.interest_group_buyers);if(t&&o.table(r),!r)return t&&o.error("No eligible interest group buyers found!"),null;t&&o.info("getting all bids from each buyer");const a=await(async(e,t,n)=>Promise.all(e.map((async e=>{const r=performance.now(),{generate_bid:a}=await import(e.bidding_logic_url);if(!a&&"function"!=typeof a)return null;const s=await k(e?.trusted_bidding_signals_url,e?.trusted_bidding_signals_keys,n);let i;try{i=a(e,t?.auction_signals,t?.per_buyer_signals?.[e.owner],s,{top_window_hostname:window.top.location.hostname,seller:t.seller})}catch(e){return n&&o.error(e),null}if(!(i.ad&&"object"==typeof i.ad&&i.bid&&"number"==typeof i.bid&&i.render)||"string"!=typeof i.render&&!Array.isArray(i.render))return null;const c=performance.now();return{...e,...i,duration:c-r}}))))(r,e,t);t&&o.table(a),t&&o.info("filtering out invalid bids");const s=a.filter((e=>e));if(t&&o.table(s),!s.length)return t&&o.error("No bids found!"),null;t&&o.info("getting all scores, filtering and sorting");const[i]=await(async(e,t,n)=>{const{score_ad:r}=await import(t.decision_logic_url);return r||"function"==typeof r?e.map((e=>{let a;try{a=r(e?.ad,e?.bid,t,t?.trusted_scoring_signals,{top_window_hostname:window.top.location.hostname,interest_group_owner:e.owner,interest_group_name:e.name,bidding_duration_msec:e.duration})}catch(e){n&&o.error(e),a=-1}return{bid:e,score:a}})).filter((({score:e})=>e>0)).sort(((e,t)=>e.score>t.score?1:-1)):null})(s,e,t);if(t&&o.log("winner:",i),!i)return t&&o.error("No winner found!"),null;t&&o.info("creating an entry in the auction store");const c=await E.store.add(v,{id:([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,(e=>(e^crypto.getRandomValues(new Uint8Array(1))[0]&15>>e/4).toString(16))),origin:`${window.top.location.origin}${window.top.location.pathname}`,timestamp:Date.now(),conf:e,...i});return t&&o.log("auction token:",c),c||(t&&o.error("No auction token found!"),null)}const j=(e,t)=>`${e}-${t}`;async function B({data:e,ports:t}){try{if(!Array.isArray(e))throw new Error("data is not what it should be");switch(e[0]){case"joinAdInterestGroup":{const[,t]=e,[n,r,a]=t;return await async function(e,t,n){n&&o.info("checking for an existing interest group");const r=await E.store.get(x,j(e.owner,e.name));let a;return n&&o.table(r),r?(n&&o.info("updating a new interest group"),a=await E.store.put(x,r,{_expired:Date.now()+t,...e})):(n&&o.info("creating a new interest group"),a=await E.store.add(x,{_key:j(e.owner,e.name),_expired:Date.now()+t,...e})),n&&o.log("interest group id:",a),!0}(n,r,a),!0}case"leaveAdInterestGroup":{const[,t]=e,[n,r]=t;return await async function(e,t){return t&&o.info("deleting an existing interest group"),await E.store.delete(x,j(e.owner,e.name)),t&&o.log("interest group deleted"),!0}(n,r),!0}case"runAdAuction":{const[,n]=e,[r,o]=n;if(1!==t.length)throw new Error(`Port transfer mismatch during request: expected 1 port, but received ${t.length}`);const[a]=t,s=[!0,await I(r,o)];return a.postMessage(s),a.close(),!0}default:return!1}}catch(e){const n=[!1];for(const e of t)e.postMessage(n);throw e}}return async function(){const{searchParams:e}=new URL(window.location),t=e.get("debug")||!1;if(t&&o.group("Fledge: Storage Frame"),!(e.get("admin")||!1)){const[e]=window.location.ancestorOrigins;if(void 0===e)throw t&&o.warn("It appears your attempting to access this from the top-level",e,window.location),new Error("Can't call 'postMessage' on the Frame window when run as a top-level document");const{port1:n,port2:r}=new MessageChannel;t&&o.log("message channel receiver:",n),t&&o.log("message channel sender:",r),n.onmessage=B,window.parent.postMessage({"fledge.polyfill":1},e,[r])}t&&o.groupEnd()}}();

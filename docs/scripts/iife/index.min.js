var fledgeframe=function(){"use strict";let e=[];const t={},n="%c ";function r(r){return function(...o){const i=[],a=[];o.forEach((r=>{if(r===t){const t=e.shift();i.push(`%c${t.value}`,n),a.push(t.css,"")}else"object"==typeof r||"function"==typeof r?(i.push("%o",n),a.push(r,"")):(i.push(`%c${r}`,n),a.push("",""))})),r(i.join(""),...a),e=[]}}var o={error:r(console.error),info:r(console.info),log:r(console.log),group:r(console.group),groupEnd:r(console.groupEnd),table:r(console.table),trace:r(console.trace),warn:r(console.warn),asAlert:function(n){return e.push({value:n,css:"display: inline-block ; background-color: #e0005a ; color: #ffffff ; font-weight: bold ; padding: 3px 7px 3px 7px ; border-radius: 3px 3px 3px 3px ;"}),t},asWarning:function(n){return e.push({value:n,css:"display: inline-block ; background-color: gold ; color: black ; font-weight: bold ; padding: 3px 7px 3px 7px ; border-radius: 3px 3px 3px 3px ;"}),t}};let i,a;const s=new WeakMap,c=new WeakMap,u=new WeakMap,d=new WeakMap,l=new WeakMap;let g={get(e,t,n){if(e instanceof IDBTransaction){if("done"===t)return c.get(e);if("objectStoreNames"===t)return e.objectStoreNames||u.get(e);if("store"===t)return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return w(e[t])},set:(e,t,n)=>(e[t]=n,!0),has:(e,t)=>e instanceof IDBTransaction&&("done"===t||"store"===t)||t in e};function p(e){return e!==IDBDatabase.prototype.transaction||"objectStoreNames"in IDBTransaction.prototype?(a||(a=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])).includes(e)?function(...t){return e.apply(h(this),t),w(s.get(this))}:function(...t){return w(e.apply(h(this),t))}:function(t,...n){const r=e.call(h(this),t,...n);return u.set(r,t.sort?t.sort():[t]),w(r)}}function f(e){return"function"==typeof e?p(e):(e instanceof IDBTransaction&&function(e){if(c.has(e))return;const t=new Promise(((t,n)=>{const r=()=>{e.removeEventListener("complete",o),e.removeEventListener("error",i),e.removeEventListener("abort",i)},o=()=>{t(),r()},i=()=>{n(e.error||new DOMException("AbortError","AbortError")),r()};e.addEventListener("complete",o),e.addEventListener("error",i),e.addEventListener("abort",i)}));c.set(e,t)}(e),t=e,(i||(i=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])).some((e=>t instanceof e))?new Proxy(e,g):e);var t}function w(e){if(e instanceof IDBRequest)return function(e){const t=new Promise(((t,n)=>{const r=()=>{e.removeEventListener("success",o),e.removeEventListener("error",i)},o=()=>{t(w(e.result)),r()},i=()=>{n(e.error),r()};e.addEventListener("success",o),e.addEventListener("error",i)}));return t.then((t=>{t instanceof IDBCursor&&s.set(t,e)})).catch((()=>{})),l.set(t,e),t}(e);if(d.has(e))return d.get(e);const t=f(e);return t!==e&&(d.set(e,t),l.set(t,e)),t}const h=e=>l.get(e);const m=["get","getKey","getAll","getAllKeys","count"],b=["put","add","delete","clear"],y=new Map;function _(e,t){if(!(e instanceof IDBDatabase)||t in e||"string"!=typeof t)return;if(y.get(t))return y.get(t);const n=t.replace(/FromIndex$/,""),r=t!==n,o=b.includes(n);if(!(n in(r?IDBIndex:IDBObjectStore).prototype)||!o&&!m.includes(n))return;const i=async function(e,...t){const i=this.transaction(e,o?"readwrite":"readonly");let a=i.store;return r&&(a=a.index(t.shift())),(await Promise.all([a[n](...t),o&&i.done]))[0]};return y.set(t,i),i}g=(e=>({...e,get:(t,n,r)=>_(t,n)||e.get(t,n,r),has:(t,n)=>!!_(t,n)||e.has(t,n)}))(g);const v="auction",E="interest-groups",k=function(e,t,{blocked:n,upgrade:r,blocking:o,terminated:i}={}){const a=indexedDB.open(e,t),s=w(a);return r&&a.addEventListener("upgradeneeded",(e=>{r(w(a.result),e.oldVersion,e.newVersion,w(a.transaction))})),n&&a.addEventListener("blocked",(()=>n())),s.then((e=>{i&&e.addEventListener("close",(()=>i())),o&&e.addEventListener("versionchange",(()=>o()))})).catch((()=>{})),s}("Fledge",1,{upgrade(e){const t=e.createObjectStore(E,{keyPath:"_key"});["owner","name","_expired"].forEach((e=>{t.createIndex(e,e,{unique:!1})})),e.createObjectStore(v,{keyPath:"id"})}});var x={db:k,store:{add:async function(e,t){return(await k).add(e,{...t,_created:Date.now(),_updated:Date.now()})},get:async function(e,t){const n=(await k).get(e,t);return n||null},getAll:async function(e){const t=(await k).getAll(e);return t||null},put:async function(e,t,n){const r={...t,...n,_updated:Date.now()};return(await k).put(e,r)},delete:async function(e,t){return(await k).delete(e,t)}}};var D=({source:e,target:t=document.body,props:n={},style:r={}})=>{if(!e)throw new Error("Something went wrong! No URL was found.");const o=new URL(e,document.baseURI),i=document.createElement("iframe"),a={src:o,scrolling:"no",...n},s={"border-width":0,...r};return Object.entries(a).map((([e,t])=>i.setAttribute(e,t))),Object.entries(s).map((([e,t])=>i.style.setProperty(e,t))),t.appendChild(i),{iframe:i,origin:o.origin}};const A={array:e=>"undefined"!==e&&Array.isArray(e),number:e=>"undefined"!==e&&"number"==typeof e,object:e=>"undefined"!==e&&"object"==typeof e&&null!==e&&!Array.isArray(e),string:e=>"undefined"!==e&&"string"==typeof e,mixed:e=>"undefined"!==e&&(Array.isArray(e)||"string"==typeof e),url:e=>{try{return Boolean(new URL(e))}catch(e){return!1}}};var I=(e,t)=>{if(!A[t](e))throw new Error(`Must be of type "${t}"! ${typeof e} was provided.`)};const j=async(e,t,n)=>{const r=`hostname=${window.top.location.hostname}`;if(!e||!t)return;const i=await fetch(`${e}?${r}&keys=${t.join(",")}`).then((e=>{if(!e.ok)throw new Error("Something went wrong! The response returned was not ok.");if(!(e=>/\bapplication\/json\b/.test(e?.headers?.get("content-type")))(e))throw new Error("Response was not in the format of JSON.");return e.json()})).catch((e=>(n&&o.error("There was a problem with your fetch operation:",e),null))),a={};for(const[e,n]of i)t.includes(e)&&(a[e]=n);return a&&0===Object.keys(a).length&&a.constructor===Object?a:null};async function $(e,t){t&&o.info("getting all interest groups");const n=await x.store.getAll(E);t&&o.table(n),t&&o.info('checking eligibility of buyers based on "interest_group_buyers"');const r=((e,t)=>{if("*"===t)return e;const n=e.filter((({owner:e})=>t.includes(e)));return n.length?n:null})(n,e.interest_group_buyers);if(t&&o.table(r),!r)return t&&o.error("No eligible interest group buyers found!"),null;t&&o.info("getting all bids from each buyer");const i=await(async(e,t,n)=>Promise.all(e.map((async e=>{const r=performance.now(),{generate_bid:i}=await import(e.bidding_logic_url);if(!i&&"function"!=typeof i)return null;const a=await j(e?.trusted_bidding_signals_url,e?.trusted_bidding_signals_keys,n);let s;try{s=i(e,t?.auction_signals,t?.per_buyer_signals?.[e.owner],a,{top_window_hostname:window.top.location.hostname,seller:t.seller})}catch(e){return n&&o.error(e),null}if(!(s.ad&&"object"==typeof s.ad&&s.bid&&"number"==typeof s.bid&&s.render)||"string"!=typeof s.render&&!Array.isArray(s.render))return null;const c=performance.now();return{...e,...s,duration:c-r}}))))(r,e,t);t&&o.table(i),t&&o.info("filtering out invalid bids");const a=i.filter((e=>e));if(t&&o.table(a),!a.length)return t&&o.error("No bids found!"),null;t&&o.info("getting all scores, filtering and sorting");const[s]=await(async(e,t,n)=>{const{score_ad:r}=await import(t.decision_logic_url);return r||"function"==typeof r?e.map((e=>{let i;try{i=r(e?.ad,e?.bid,t,t?.trusted_scoring_signals,{top_window_hostname:window.top.location.hostname,interest_group_owner:e.owner,interest_group_name:e.name,bidding_duration_msec:e.duration})}catch(e){n&&o.error(e),i=-1}return{bid:e,score:i}})).filter((({score:e})=>e>0)).sort(((e,t)=>e.score>t.score?1:-1)):null})(a,e,t);if(t&&o.log("winner:",s),!s)return t&&o.error("No winner found!"),null;t&&o.info("creating an entry in the auction store");const c=await x.store.add(v,{id:([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,(e=>(e^crypto.getRandomValues(new Uint8Array(1))[0]&15>>e/4).toString(16))),origin:`${window.top.location.origin}${window.top.location.pathname}`,timestamp:Date.now(),conf:e,...s});return t&&o.log("auction token:",c),c?(t&&o.groupEnd(),c):(t&&o.error("No auction token found!"),null)}const B=(e,t)=>`${e}-${t}`;const S=e=>document.querySelector(e);async function L(e,t,n){n&&o.group("Fledge: Render an Ad"),n&&o.log("ad render selector:",e),n&&o.log("ad render token:",t),I(e,"string"),I(t,"string"),n&&o.info("checking that target exists on the page");const r=S(e);if(n&&o.log("target:",r),!r)throw new Error(`Target not found on the page! Please check that ${r} exists on the page.`);n&&o.info("checking that winning token exists");const i=await x.store.get(v,t);if(n&&o.log("winners token:",i),!i||i.id!==t)throw new Error(`A token was not found! Token provided: ${t}`);if(n&&o.info("checking that winner to be rendered is on the same hostname as the auction"),i?.origin!==`${window.top.location.origin}${window.top.location.pathname}`)throw n&&o.error("Attempting to render the winner on a location that doesn't match the auctions hostname",{winner:i.origin,auction:`${window.top.location.origin}${window.top.location.pathname}`}),new Error("Something went wrong! No ad was rendered.");n&&o.info("rendering an iframe with the winning ad"),D(i.bid.render,r,{id:`fledge-auction-${i.id}`}),n&&o.info("checking that ad iframe actually rendered");const a=S(`#fledge-auction-${t}`);if(n&&o.log("ads target:",a),!a||!(e=>{if(!(e instanceof Element))throw Error(`${e} is not a DOM element.`);const{display:t,opacity:n,visibility:r}=getComputedStyle(e);if("none"===t)return!1;if("visible"!==r)return!1;if(n<.1)return!1;const{left:o,height:i,top:a,width:s}=e.getBoundingClientRect(),{offsetHeight:c}=e,{offsetWidth:u}=e;if(u+c+i+s===0)return!1;const d=o+u/2;if(d<0)return!1;if(d>(document.documentElement.clientWidth||window.innerWidth))return!1;const l=a+c/2;if(l<0)return!1;if(l>(document.documentElement.clientHeight||window.innerHeight))return!1;let g=document.elementFromPoint(d,l);do{if(g===e)return!0}while(g=g.parentNode);return!1})(a))throw new Error("Something went wrong! No ad was rendered.");n&&o.groupEnd(),n&&o.group("Fledge: Reporting"),n&&o.info("sending reports to the seller");const s=await(async(e,t)=>{const{report_result:n}=await import(e.decision_logic_url);if(!n||"function"!=typeof n)return null;try{return n(e,{top_window_hostname:window.top.location.hostname,interest_group_owner:t.bid.owner,interest_group_name:t.bid.name,render_url:t.bid.render,bid:t.bid.bid})}catch(e){return o.error(e),null}})(i.conf,i);return n&&o.info("sending reports to the buyer",s),await(async(e,t,n)=>{const{report_win:r}=await import(t.bid.bidding_logic_url);if(!r||"function"!=typeof r)return null;try{return r(e?.auction_signals,e?.per_buyer_signals?.[t.bid.owner],n,{top_window_hostname:window.top.location.hostname,interest_group_owner:t.bid.owner,interest_group_name:t.bid.name,render_url:t.bid.render,bid:t.bid.bid})}catch(e){return o.error(e),null}})(i.conf,i,s),n&&o.groupEnd(),!0}async function N({data:e,ports:t}){try{if(!Array.isArray(e))throw new Error("data is not what it should be");switch(e[0]){case"joinAdInterestGroup":{const[,t]=e,[n,r,i]=t;return await async function(e,t,n){n&&o.info("checking for an existing interest group");const r=await x.store.get(E,B(e.owner,e.name));let i;return n&&o.table(r),r?(n&&o.info("updating a new interest group"),i=await x.store.put(E,r,{_expired:Date.now()+t,...e})):(n&&o.info("creating a new interest group"),i=await x.store.add(E,{_key:B(e.owner,e.name),_expired:Date.now()+t,...e})),n&&o.log("interest group id:",i),n&&o.groupEnd(),!0}(n,r,i),!0}case"leaveAdInterestGroup":{const[,t]=e,[n,r]=t;return await async function(e,t){return t&&o.info("deleting an existing interest group"),await x.store.delete(E,B(e.owner,e.name)),t&&o.log("interest group deleted"),t&&o.groupEnd(),!0}(n,r),!0}case"runAdAuction":{const[,n]=e,[r,o]=n;if(1!==t.length)throw new Error(`Port transfer mismatch during request: expected 1 port, but received ${t.length}`);const[i]=t,a=[!0,await $(r,o)];return i.postMessage(a),i.close(),!0}case"renderAd":{const[,t]=e,[n,r,o]=t;return await L(n,r,o),!0}default:return!1}}catch(e){const n=[!1];for(const e of t)e.postMessage(n);throw e}}return async function(e=!1){const[t]=window.location.ancestorOrigins;void 0===t&&o.warn("Frame cannot run as a top-level document");const{port1:n,port2:r}=new MessageChannel;e&&o.log("message channel receiver:",n),e&&o.log("message channel sender:",r),n.onmessage=N,window.parent.postMessage({"fledge.polyfill":1},t,[r])}}();

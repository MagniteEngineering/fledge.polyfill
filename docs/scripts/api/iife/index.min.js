var fledge=function(e){"use strict";const r={seller:"string",decisionLogicUrl:"url",interestGroupBuyers:"mixed",trustedScoringSignalsUrl:"url",additionalBids:"array",auctionSignals:"object",sellerSignals:"object",perBuyerSignals:"object"},t={owner:"string",name:"string",biddingLogicUrl:"url",dailyUpdateUrl:"url",trustedBiddingSignalsUrl:"url",trustedBiddingSignalsKeys:"array",userBiddingSignals:"object",ads:"array"},o=(e,r,t)=>r.map((r=>`'${r}' requires a type of "${t[r]}"! A type of ${typeof e[r]} was provided instead.`)),n={array:e=>"undefined"!==e&&Array.isArray(e),number:e=>"undefined"!==e&&"number"==typeof e,object:e=>"undefined"!==e&&"object"==typeof e&&null!==e&&!Array.isArray(e),string:e=>"undefined"!==e&&"string"==typeof e,mixed:e=>"undefined"!==e&&(Array.isArray(e)||"string"==typeof e),url:e=>{try{return Boolean(new URL(e))}catch(e){return!1}}},i=(e,r)=>new Promise(((t,o)=>{const n=o=>{r(o)&&(e.removeEventListener("message",n),e.removeEventListener("messageerror",i),t(o))},i=t=>{r(t)&&(e.removeEventListener("message",n),e.removeEventListener("messageerror",i),o(new Error("Message deserialization error")))};e.addEventListener("message",n),e.addEventListener("messageerror",i)}));const s=async(e,r,...t)=>{const[o,n]=await(i=import(e),i.then((e=>[e,void 0])).catch((e=>Promise.resolve([void 0,e]))));var i;if(n)return null;if(!o[r]||"function"!=typeof o[r])return null;try{return o[r](...t)}catch(e){return null}},a=({source:e,target:r=document.body,props:t={},style:o={}})=>{if(!e)throw new Error("Something went wrong! No URL was found.");const n=new URL(e,document.baseURI),i=document.createElement("iframe"),s={src:n,scrolling:"no",...t},a={"border-width":0,...o};return Object.entries(s).map((([e,r])=>i.setAttribute(e,r))),Object.entries(a).map((([e,r])=>i.style.setProperty(e,r))),r.appendChild(i),{iframe:i,origin:n.origin}},d={getFramePort:async function(e,r){const{data:t,ports:o,origin:n}=await i(window,(({source:r})=>r===e.contentWindow));if(n!==r)throw new Error(`Message origins are mismatched! Expected ${r}, received ${n}`);if(1!==t["fledge.polyfill"])throw new Error(`Message versions are mismatched! Expected 1, but received ${t["fledge.polyfill"]}`);if(1!==o.length)throw new Error(`Message ports are mismatched! Expected 1 port, received ${o.length}`);return o[0]},getFromFrame:function(e){const r=i(e,(()=>!0));return e.start(),r},get:i},l=(e,r)=>{const t=Object.entries(e).filter((([e,t])=>!n[r[e]](t))).flatMap((([e])=>e));if(t.length)throw new Error(o(e,t,r).join(". "));return!1},c=(e,r)=>{const t=r.filter((r=>!e.hasOwnProperty(r)));if(t.length)throw new Error(`Required options are missing! You must provide an 'object' of options with all of the following required options: ${t.join(", ")}.`);return!1},u=(e,r)=>{if(!n[r](e))throw new Error(`Must be of type "${r}"! ${typeof e} was provided.`)},p=2592e6;return e.Fledge=class{constructor(e){this.url=e||"http://localhost:8000/iframe.html";const{iframe:r,origin:t}=a({source:this.url,style:{display:"none"}});r.sandbox.add("allow-same-origin","allow-scripts");const o=d.getFramePort(r,t);this._props={iframe:r,port:o}}get props(){return this._props}async joinAdInterestGroup(e,r){if(u(e,"object"),u(r,"number"),c(e,["owner","name","biddingLogicUrl"]),l(e,t),r>p)throw new Error("'expiry' is set past the allowed maximum value. You must provide an expiration that is less than or equal to 2592000000.");(await this.props.port).postMessage(["joinAdInterestGroup",[e,r]])}async leaveAdInterestGroup(e){u(e,"object"),c(e,["owner","name"]),l(e,t);(await this.props.port).postMessage(["leaveAdInterestGroup",[e]])}async runAdAuction(e){u(e,"object"),c(e,["seller","decisionLogicUrl","interestGroupBuyers"]),l(e,r);const t=await this.props.port,{port1:o,port2:n}=new MessageChannel;try{t.postMessage(["runAdAuction",[e]],[n]);const{data:r}=await d.getFromFrame(o);if(!r[0])throw new Error("No response from the iframe was found!");const[,i]=r;return i}finally{o.close()}}},e.renderFledgeAd=async function(e,r){u(e,"string"),u(r,"string");const t=document.querySelector(e);if(!t)throw new Error(`Target not found on the page! Please check that ${t} exists on the page.`);const{origin:o,conf:n,winner:i}=JSON.parse(sessionStorage.getItem(r));if(!i)throw new Error(`A token was not found! Token provided: ${r}`);if(o!==`${window.top.location.origin}${window.top.location.pathname}`)throw new Error("The ads origin does not match the hosts origin!  No ad was rendered.");if(a({source:i.bid.render,target:t,props:{id:`fledge-auction-${r}`}}),!document.querySelector(`#fledge-auction-${r}`))throw new Error("Something went wrong! No ad was rendered.");const d=await s(n.decisionLogicUrl,"reportResult",n,{topWindowHostname:window.top.location.hostname,interestGroupOwner:i.bid.owner,interestGroupName:i.bid.name,renderUrl:i.bid.render,bid:i.bid.bid});await s(i.bid.biddingLogicUrl,"reportWin",n?.auctionSignals,n?.perBuyerSignals?.[i.bid.owner],d,{topWindowHostname:window.top.location.hostname,interestGroupOwner:i.bid.owner,interestGroupName:i.bid.name,renderUrl:i.bid.render,bid:i.bid.bid})},e}({});
